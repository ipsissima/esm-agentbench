# dev-tools/Dockerfile.kernel
FROM ubuntu:22.04
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential curl wget git ca-certificates m4 bubblewrap \
    ocaml ocaml-native-compilers opam \
    python3 python3-venv python3-pip unzip \
    pkg-config libgmp-dev libgmpxx4ldbl \
    autoconf automake libtool gettext \
  && rm -rf /var/lib/apt/lists/*

ENV OPAMROOT=/opt/opam
RUN mkdir -p /opt/opam && chmod 0777 /opt/opam
RUN opam init --bare --disable-sandboxing --root=/opt/opam
RUN opam switch create esm-kernel 4.14.0 || opam switch set esm-kernel
ENV OPAMSWITCH=esm-kernel
RUN eval $(opam env) && opam install -y opam-depext \
  && opam depext -i coq.8.18.0
RUN eval $(opam env) && opam install -y coq.8.18.0 dune ocamlfind
# put opam env in /etc/profile.d for interactive shells
RUN eval $(opam env --switch=esm-kernel) \
 && echo 'eval $(opam env --switch=esm-kernel)' > /etc/profile.d/opam-env.sh \
 # ensure critical binaries are symlinked into /usr/local/bin so non-login shells find them
 && mkdir -p /usr/local/bin \
 && for b in coqc coqtop ocamlopt ocamlfind; do \
      BIN=$(opam var bin)/$b 2>/dev/null || BIN=""; \
      [ -x "$BIN" ] && ln -sf "$BIN" /usr/local/bin/$b || true; \
    done

WORKDIR /work
COPY UELAT /work/UELAT
COPY build_kernel.sh /work/build_kernel.sh
CMD ["/bin/bash","-lc","eval $(opam env --switch=esm-kernel) >/dev/null 2>&1 || true; /work/build_kernel.sh"]
