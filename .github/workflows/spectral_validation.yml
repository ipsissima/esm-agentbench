name: Spectral Certificate Validation

on:
  push:
    branches:
      - 'claude/*'
      - 'agentbeats/phase1-*'
      - main
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      RUN_TUNING:
        description: "Run nested CV tuning pipeline"
        required: false
        default: "false"

env:
  SPECTRAL_MIN_AUC: "0.90"
  SPECTRAL_MIN_TPR_FPR05: "0.80"
  # Skip verified kernel (requires Coq/OCaml build) and use Python fallback
  ESM_SKIP_VERIFIED_KERNEL: "1"
  # CRITICAL: Default to NOT generating synthetic traces (set to "1" only for dev testing)
  ALLOW_SYNTHETIC_TRACES: "0"
  # This is NOT a Phase-1 evidence run (set to "1" in agentbeats_phase1.yml)
  PHASE1_EVIDENCE: "0"

jobs:
  validate-spectral:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Setup Python venv
        run: |
          python -m venv .venv
          . .venv/bin/activate
          python -m pip install --upgrade pip setuptools wheel

      - name: Install HF stack + project
        run: |
          . .venv/bin/activate
          python -m pip uninstall -y huggingface-hub sentence-transformers transformers || true
          # canonical HF stack
          python -m pip install --no-cache-dir "huggingface-hub==0.16.4" "sentence-transformers==2.3.1" "transformers==4.35.2"
          python -m pip install --no-cache-dir -r requirements.txt --no-deps
          python -m pip install -e .

      - name: Verify importability
        run: |
          . .venv/bin/activate
          python - <<'PY'
          import sys, importlib
          importlib.invalidate_caches()
          try:
              import tools
              print("tools importable:", tools.__file__)
          except Exception as e:
              print("ERROR: tools not importable:", e, file=sys.stderr)
              raise
          PY

      - name: Run tuning pipeline (manual only)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.RUN_TUNING == 'true' }}
        run: |
          . .venv/bin/activate
          python tools/tune_metric.py --features-csv reports/features_dev.csv --groups-col scenario --label-col label --fpr-target 0.05 --seed 0
          python tools/eval_holdout.py --model reports/best_model.pkl --features-csv reports/features_holdout.csv --fpr-target 0.05 --n-boot 1000 --seed 0

      - name: Sanity check: ensure real traces exist (Phase1 mode)
        run: |
          if [ "${{ env.PHASE1_EVIDENCE }}" = "1" ]; then
            echo "Phase-1 evidence run: checking for real traces in submissions/ipsissima."
            missing=0
            for s in scenarios/*; do
              if [ -d "$s" ]; then
                scenario=$(basename "$s")
                pattern="submissions/ipsissima/${scenario}/experiment_traces_real_hf/*/*/*.json"
                count=$(bash -lc "ls $pattern 2>/dev/null | wc -l")
                if [ "$count" -eq 0 ]; then
                  echo "Missing real traces for scenario ${scenario}"
                  missing=1
                fi
              fi
            done
            if [ "$missing" -eq 1 ]; then
              echo "ERROR: Missing real traces for one or more Phase-1 scenarios. Aborting."
              exit 2
            fi
          else
            echo "Not a Phase-1 evidence run: skipping strict real-trace check."
          fi

      - name: Run spectral prover unit tests
        run: |
          . .venv/bin/activate
          pytest tests/test_spectral_prover.py -v --tb=short

      - name: Check synthetic generator exists
        if: ${{ env.ALLOW_SYNTHETIC_TRACES == '1' }}
        run: |
          if [ ! -f tools/dev/generate_synthetic_traces.py ]; then
            echo "ERROR: tools/dev/generate_synthetic_traces.py missing; update repository or workflow."
            exit 2
          fi
          echo "âœ“ Synthetic trace generator found"

      - name: Generate synthetic traces (dev-only)
        if: ${{ env.ALLOW_SYNTHETIC_TRACES == '1' }}
        run: |
          . .venv/bin/activate
          python tools/dev/generate_synthetic_traces.py --n 30 --seed 42 --out-dir dev_artifacts/experiment_traces

      - name: Run spectral validation experiments
        id: validation
        run: |
          . .venv/bin/activate
          traces_dir="experiment_traces"
          if [ "${{ env.ALLOW_SYNTHETIC_TRACES }}" = "1" ]; then
            traces_dir="dev_artifacts/experiment_traces"
          fi
          echo "Running spectral validation on all scenarios..."
          python analysis/run_experiment.py --all-scenarios --k 10 --traces-dir "$traces_dir"

          # Check validation results
          echo "Checking validation results..."

          VALIDATION_PASSED=true

          for report in reports/spectral_validation/*/validation_report.json; do
            if [ -f "$report" ]; then
              scenario=$(dirname "$report" | xargs basename)
              auc=$(python -c "import json; print(json.load(open('$report'))['AUC'])")
              tpr=$(python -c "import json; print(json.load(open('$report'))['TPR_at_FPR05'])")

              echo "Scenario: $scenario"
              echo "  AUC: $auc (threshold: $SPECTRAL_MIN_AUC)"
              echo "  TPR@FPR05: $tpr (threshold: $SPECTRAL_MIN_TPR_FPR05)"

              # Check thresholds
              auc_ok=$(python -c "print('1' if $auc >= $SPECTRAL_MIN_AUC else '0')")
              tpr_ok=$(python -c "print('1' if $tpr >= $SPECTRAL_MIN_TPR_FPR05 else '0')")

              if [ "$auc_ok" != "1" ] || [ "$tpr_ok" != "1" ]; then
                echo "  STATUS: WARN - thresholds not met"
                VALIDATION_PASSED=false
              else
                echo "  STATUS: PASS"
              fi
            fi
          done

          echo "validation_passed=$VALIDATION_PASSED" >> $GITHUB_OUTPUT

          if [ "$VALIDATION_PASSED" = "false" ]; then
            echo ""
            echo "WARNING: Some scenarios did not meet validation thresholds."
            echo "This may indicate the synthetic data or parameters need adjustment."
            echo "Review the reports for details."
            exit 1
          fi

      - name: Enforce real-only evidence for Phase-1
        if: always()
        run: |
          . .venv/bin/activate
          # Only enforce when this run is intended as Phase-1 evidence
          if [ "${{ env.PHASE1_EVIDENCE }}" = "1" ]; then
            echo "Phase-1 evidence run: enforcing data_source == real_traces_only"
            missing=0
            
            # Check all validation reports
            for report in reports/spectral_validation/*/validation_report.json; do
              if [ -f "$report" ]; then
                # Try to parse JSON, if it fails the report is invalid
                if ! python -c "import json; json.load(open('$report'))" 2>/dev/null; then
                  echo "ERROR: $report is not valid JSON"
                  missing=1
                  continue
                fi
                ds=$(python -c "import json; print(json.load(open('$report')).get('data_source', 'MISSING'))")
                if [ "$ds" != "real_traces_only" ]; then
                  echo "ERROR: $report has data_source=$ds (expected real_traces_only)"
                  missing=1
                fi
              fi
            done
            
            # Check all experiment traces
            for trace in experiment_traces/*/*.json; do
              if [ -f "$trace" ]; then
                # Try to parse JSON, if it fails the trace is invalid
                if ! python -c "import json; json.load(open('$trace'))" 2>/dev/null; then
                  echo "ERROR: $trace is not valid JSON"
                  missing=1
                  continue
                fi
                ds=$(python -c "import json; print(json.load(open('$trace')).get('data_source', 'MISSING'))")
                if [ "$ds" != "real_traces_only" ]; then
                  echo "ERROR: synthetic or missing data_source in $trace: $ds"
                  missing=1
                fi
              fi
            done
            
            if [ "$missing" = "1" ]; then
              echo "One or more reports/traces are not real_traces_only. Failing."
              exit 1
            fi
            echo "All reports and traces declare real_traces_only."
          else
            echo "Not a Phase-1 evidence run: skipping enforcement."
          fi

      - name: Upload validation reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: spectral-validation-reports
          path: |
            reports/spectral_validation/
            experiment_traces/
          retention-days: 30

      - name: Post validation summary
        if: always()
        run: |
          echo "## Spectral Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.ALLOW_SYNTHETIC_TRACES }}" = "1" ]; then
            echo "**Note:** Synthetic traces were generated for this run (dev-only)." >> $GITHUB_STEP_SUMMARY
          else
            echo "**Note:** Synthetic trace generation was disabled (ALLOW_SYNTHETIC_TRACES=0)." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "| Scenario | AUC | TPR@FPR05 | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-----|-----------|--------|" >> $GITHUB_STEP_SUMMARY

          for report in reports/spectral_validation/*/validation_report.json; do
            if [ -f "$report" ]; then
              scenario=$(dirname "$report" | xargs basename)
              auc=$(python -c "import json; print(f\"{json.load(open('$report'))['AUC']:.4f}\")")
              tpr=$(python -c "import json; print(f\"{json.load(open('$report'))['TPR_at_FPR05']:.4f}\")")

              auc_ok=$(python -c "print('1' if float('$auc') >= float('$SPECTRAL_MIN_AUC') else '0')")
              tpr_ok=$(python -c "print('1' if float('$tpr') >= float('$SPECTRAL_MIN_TPR_FPR05') else '0')")

              if [ "$auc_ok" = "1" ] && [ "$tpr_ok" = "1" ]; then
                status="PASS"
              else
                status="WARN"
              fi

              echo "| $scenario | $auc | $tpr | $status |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Thresholds: AUC >= $SPECTRAL_MIN_AUC, TPR@FPR05 >= $SPECTRAL_MIN_TPR_FPR05" >> $GITHUB_STEP_SUMMARY

  run-full-test-suite:
    runs-on: ubuntu-latest
    needs: validate-spectral

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m venv .venv
          . .venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip uninstall -y huggingface-hub sentence-transformers transformers || true
          python -m pip install --no-cache-dir "huggingface-hub==0.16.4" "sentence-transformers==2.3.1" "transformers==4.35.2"
          python -m pip install --no-cache-dir -r requirements.txt --no-deps
          python -m pip install -e .

      - name: Verify tools and python
        run: |
          . .venv/bin/activate
          python -c "import sys, importlib; importlib.invalidate_caches(); import tools; print('tools at', tools.__file__)"

      - name: Run all tests
        env:
          # Skip tests that import native embedding libraries (may SIGSEGV outside Docker)
          SKIP_NATIVE_EMBEDDING_TESTS: "1"
        run: |
          . .venv/bin/activate
          pytest tests/ -v --tb=short -x
