name: AgentBeats Phase1 Validation

on:
  push:
    branches:
      - 'agentbeats/phase1-submission-*'
      - 'claude/*'
  pull_request:
    branches:
      - main

jobs:
  build_verified_kernel:
    name: Build Verified Kernel (Docker Coq 8.18.0)
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive

    - name: Ensure docker available
      run: docker --version

    - name: Verify Coq image available
      run: docker pull coqorg/coq:8.18.0

    - name: Prepare workspace files & permissions
      run: |
        mkdir -p .kernel_out
        chmod -R a+rwX .kernel_out || true

    - name: Build kernel inside Coq 8.18.0 image
      run: |
        docker run --rm --user root \
          -v "${{ github.workspace }}":/work \
          -v "${{ github.workspace }}/.kernel_out":/kernel_out \
          -w /work \
          -e OPAMROOT=/home/coq/.opam \
          -e OPAMCONFIRMLEVEL=unsafe-yes \
          coqorg/coq:8.18.0 \
          bash -c "eval \$(opam env 2>/dev/null) && KERNEL_OUTPUT=/kernel_out/kernel_verified.so bash ./build_kernel.sh"

    - name: Verify created artifact and produce checksum
      run: |
        if [ ! -f ".kernel_out/kernel_verified.so" ]; then
          echo "ERROR: .kernel_out/kernel_verified.so not produced"
          ls -la .kernel_out || true
          exit 1
        fi
        # Use relative path in checksum so it works after artifact download to UELAT/
        (cd .kernel_out && sha256sum kernel_verified.so > kernel_verified.so.sha256)
        echo "Produced:"
        cat .kernel_out/kernel_verified.so.sha256

    - name: (Optional) Sign artifact (if signing is desired)
      run: |
        if command -v python3 >/dev/null 2>&1 && [ -f tools/sign_index.py ]; then
          chmod +x .github/scripts/sign_artifact.sh || true
          .github/scripts/sign_artifact.sh
        fi
        ls -la .kernel_out || true
      shell: bash

    - name: Upload verified kernel artifact
      uses: actions/upload-artifact@v4
      with:
        name: verified-kernel
        path: |
          .kernel_out/kernel_verified.so
          .kernel_out/kernel_verified.so.sha256
          .kernel_out/kernel_verified.so.sha256.sig
        if-no-files-found: error

  validate-phase1:
    runs-on: ubuntu-latest
    needs: build_verified_kernel
    env:
      PHASE1_EVIDENCE: "1"
    strategy:
      matrix:
        python-version: ["3.11"]
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive

    - name: Download kernel artifact
      uses: actions/download-artifact@v4
      with:
        name: verified-kernel
        path: UELAT/

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Set VERIFIED_KERNEL_PATH and verify checksum
      run: |
        if [ -f "${{ github.workspace }}/UELAT/kernel_verified.so" ]; then
          echo "Using prebuilt kernel: UELAT/kernel_verified.so"
          echo "VERIFIED_KERNEL_PATH=${{ github.workspace }}/UELAT/kernel_verified.so" >> $GITHUB_ENV
          # Run from UELAT/ dir since checksum file contains relative path
          (cd UELAT && sha256sum -c kernel_verified.so.sha256) || (echo "checksum mismatch" && exit 1)
          # optional signature verification
          if [ -f "UELAT/kernel_verified.so.sha256.sig" ] && [ -f "UELAT/public.key" ]; then
            python3 -m pip install --no-cache-dir PyNaCl || true
            python3 tools/verify_signature.py --index UELAT/kernel_verified.so.sha256 --sig UELAT/kernel_verified.so.sha256.sig --pubkey UELAT/public.key
          fi
          echo "ESM_SKIP_VERIFIED_KERNEL=0" >> $GITHUB_ENV
        else
          echo "No prebuilt kernel found; falling back to source build (not recommended for judge runs)."
          echo "ESM_SKIP_VERIFIED_KERNEL=1" >> $GITHUB_ENV
        fi

    - name: Setup Python venv
      run: |
        python -m venv .venv
        . .venv/bin/activate
        python -m pip install --upgrade pip setuptools wheel

    - name: Install HF stack + project
      run: |
        . .venv/bin/activate
        python -m pip uninstall -y huggingface-hub sentence-transformers transformers || true
        # canonical HF stack
        python -m pip install --no-cache-dir "huggingface-hub==0.16.4" "sentence-transformers==2.3.1" "transformers==4.35.2"
        python -m pip install --no-cache-dir -r requirements.txt --no-deps
        python -m pip install -e .[signing]

    - name: Verify importability
      run: |
        . .venv/bin/activate
        python - <<'PY'
        import sys, importlib
        importlib.invalidate_caches()
        try:
            import tools
            print("tools importable:", tools.__file__)
        except Exception as e:
            print("ERROR: tools not importable:", e, file=sys.stderr)
            raise
        PY

    - name: Verify kernel is available
      run: |
        . .venv/bin/activate
        export VERIFIED_KERNEL_PATH="${PWD}/UELAT/kernel_verified.so"
        ls -la "${VERIFIED_KERNEL_PATH}"
        # Test kernel loading
        python - <<'PY'
        import subprocess
        from certificates.verified_kernel import load_kernel

        try:
            load_kernel(strict=True)
        except Exception as exc:
            print("ERROR: Kernel failed to load:", exc)
            print("=== versions ===")
            for cmd in (("coqc", "--version"), ("ocamlopt", "-version")):
                try:
                    out = subprocess.check_output(cmd, stderr=subprocess.STDOUT, text=True)
                    print(cmd, "=>", out.splitlines()[0] if out else out)
                except Exception as ex:
                    print("Failed to run", cmd, ":", ex)
            raise
        PY
      env:
        VERIFIED_KERNEL_PATH: ${{ github.workspace }}/UELAT/kernel_verified.so

    - name: Start green assessor (background)
      run: |
        . .venv/bin/activate
        nohup python -m esmassessor.green_server --port 8080 --show-logs > assessor.log 2>&1 &
        sleep 3
        # Verify server is running
        curl -s http://localhost:8080/health || echo "Server health check (may not be implemented)"

    - name: Generate real agent traces (judge mode)
      run: |
        . .venv/bin/activate
        export VERIFIED_KERNEL_PATH="${PWD}/UELAT/kernel_verified.so"
        echo "Generating real agent traces for all scenarios (judge mode: small, CPU-friendly)..."

        # Run judge mode for each scenario to generate traces
        for s in scenarios/*; do
          if [ -d "$s" ]; then
            scenario=$(basename "$s")
            echo "==> Generating traces for $scenario"
            python tools/real_agents_hf/run_real_agents.py \
              --mode small \
              --scenario "$scenario" \
              --n 10 \
              --max-steps 20 || {
                echo "ERROR: Failed to generate traces for $scenario"
                exit 1
              }
          fi
        done

        echo "All traces generated successfully!"
      env:
        VERIFIED_KERNEL_PATH: ${{ github.workspace }}/UELAT/kernel_verified.so

    - name: Validate scenarios
      run: |
        . .venv/bin/activate
        export VERIFIED_KERNEL_PATH="${PWD}/UELAT/kernel_verified.so"
        echo "Validating Phase-1 scenarios with verified kernel..."
        for s in scenarios/*; do
          if [ -d "$s" ]; then
            echo "==> Running baseline for $s"
            (cd "$s" && python baseline_test.py)
            echo "==> Running plugin for $s"
            (cd "$s" && python plugin.py)
            if [ ! -f "$s/attack_succeeded.json" ]; then
              echo "ERROR: Missing attack_succeeded.json in $s"
              exit 1
            fi
            # Check success:true
            ok=$(python3 -c "import json; j=json.load(open('$s/attack_succeeded.json')); print('TRUE' if j.get('success') else 'FALSE')")
            echo "    attack_succeeded.json success: $ok"
            if [ "$ok" != "TRUE" ]; then
              echo "ERROR: attack_succeeded.json success != true in $s"
              cat "$s/attack_succeeded.json"
              exit 1
            fi
          fi
        done
        echo "All scenarios validated successfully!"
      env:
        VERIFIED_KERNEL_PATH: ${{ github.workspace }}/UELAT/kernel_verified.so

    - name: Run Phase-1 submission tests
      run: |
        . .venv/bin/activate
        export VERIFIED_KERNEL_PATH="${PWD}/UELAT/kernel_verified.so"
        pytest tests/test_kernel_load.py -v
        pytest tests/test_signature_attestation.py -v
        pytest tests/test_harness_no_wildcard.py -v
        pytest tests/test_phase1_submission.py -v
      env:
        VERIFIED_KERNEL_PATH: ${{ github.workspace }}/UELAT/kernel_verified.so

    - name: Run spectral validation with augmented classifier
      run: |
        . .venv/bin/activate
        export VERIFIED_KERNEL_PATH="${PWD}/UELAT/kernel_verified.so"
        traces_dir="submissions/ipsissima"
        if [ ! -d "$traces_dir" ]; then
          traces_dir="experiment_traces"
        fi
        python analysis/run_experiment.py --all-scenarios --traces-dir "$traces_dir" --use-augmented-classifier --fpr-target 0.05
      env:
        VERIFIED_KERNEL_PATH: ${{ github.workspace }}/UELAT/kernel_verified.so

    - name: Run repository validation demo
      run: |
        . .venv/bin/activate
        export VERIFIED_KERNEL_PATH="${PWD}/.kernel_out/kernel_verified.so"
        python tools/run_demo.py || true
      env:
        VERIFIED_KERNEL_PATH: ${{ github.workspace }}/.kernel_out/kernel_verified.so

    - name: Enforce real-only evidence (Phase-1)
      run: |
        . .venv/bin/activate
        missing=0
        for report in reports/spectral_validation/*/validation_report.json; do
          if [ -f "$report" ]; then
            ds=$(jq -r '.data_source // "MISSING"' "$report")
            if [ "$ds" != "real_traces_only" ]; then
              echo "ERROR: $report has data_source=$ds (expected real_traces_only)"
              missing=1
            fi
          fi
        done
        if [ "$missing" -eq 1 ]; then
          echo "One or more reports are not real_traces_only. Failing Phase-1 evidence job."
          exit 2
        fi

    - name: Upload scenario artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: scenario-artifacts
        path: |
          scenarios/*/attack_succeeded.json
          scenarios/*/attack_out/
          assessor.log
