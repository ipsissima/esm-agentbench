name: AgentBeats Phase1 Validation

on:
  push:
    branches:
      - 'agentbeats/phase1-submission-*'
      - 'claude/*'
  pull_request:
    branches:
      - main

jobs:
  build_verified_kernel:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Coq and OCaml
      run: |
        sudo apt-get update
        sudo apt-get install -y coq ocaml ocaml-native-compilers ocaml-findlib opam
        # Initialize opam if needed
        opam init -y --disable-sandboxing || true
        eval $(opam env)

    - name: Build verified kernel
      run: |
        ./build_kernel.sh || {
          echo "ERROR: Kernel build failed. Phase-1 validation requires verified kernel."
          echo "The build_kernel.sh script needs Coq and OCaml to compile formal proofs."
          echo "If building on a local runner, ensure Coq/OCaml are installed."
          exit 1
        }

    - name: Upload kernel artifact
      uses: actions/upload-artifact@v3
      with:
        name: verified-kernel
        path: UELAT/kernel_verified.so
        if-no-files-found: error

  validate-phase1:
    runs-on: ubuntu-latest
    needs: build_verified_kernel
    strategy:
      matrix:
        python-version: ["3.11"]
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Download kernel artifact
      uses: actions/download-artifact@v3
      with:
        name: verified-kernel
        path: UELAT/

    - name: Install dependencies
      run: |
        python -m venv .venv
        . .venv/bin/activate
        pip install --no-cache-dir "huggingface-hub==0.13.5" "sentence-transformers==2.3.0"
        pip install -r requirements.txt
        pip install pytest
        pip install -e .

    - name: Verify kernel is available
      run: |
        . .venv/bin/activate
        export VERIFIED_KERNEL_PATH="${PWD}/UELAT/kernel_verified.so"
        ls -la "${VERIFIED_KERNEL_PATH}"
        # Test kernel loading
        python -c "from certificates.verified_kernel import load_kernel; load_kernel(strict=True)" || {
          echo "ERROR: Kernel failed to load"
          exit 1
        }
      env:
        VERIFIED_KERNEL_PATH: ${{ github.workspace }}/UELAT/kernel_verified.so

    - name: Start green assessor (background)
      run: |
        . .venv/bin/activate
        nohup python -m esmassessor.green_server --port 8080 --show-logs > assessor.log 2>&1 &
        sleep 3
        # Verify server is running
        curl -s http://localhost:8080/health || echo "Server health check (may not be implemented)"

    - name: Validate scenarios
      run: |
        . .venv/bin/activate
        export VERIFIED_KERNEL_PATH="${PWD}/UELAT/kernel_verified.so"
        echo "Validating Phase-1 scenarios with verified kernel..."
        for s in scenarios/*; do
          if [ -d "$s" ]; then
            echo "==> Running baseline for $s"
            (cd "$s" && python baseline_test.py)
            echo "==> Running plugin for $s"
            (cd "$s" && python plugin.py)
            if [ ! -f "$s/attack_succeeded.json" ]; then
              echo "ERROR: Missing attack_succeeded.json in $s"
              exit 1
            fi
            # Check success:true
            ok=$(python3 -c "import json; j=json.load(open('$s/attack_succeeded.json')); print('TRUE' if j.get('success') else 'FALSE')")
            echo "    attack_succeeded.json success: $ok"
            if [ "$ok" != "TRUE" ]; then
              echo "ERROR: attack_succeeded.json success != true in $s"
              cat "$s/attack_succeeded.json"
              exit 1
            fi
          fi
        done
        echo "All scenarios validated successfully!"
      env:
        VERIFIED_KERNEL_PATH: ${{ github.workspace }}/UELAT/kernel_verified.so

    - name: Run Phase-1 submission tests
      run: |
        . .venv/bin/activate
        export VERIFIED_KERNEL_PATH="${PWD}/UELAT/kernel_verified.so"
        pytest tests/test_phase1_submission.py -v
      env:
        VERIFIED_KERNEL_PATH: ${{ github.workspace }}/UELAT/kernel_verified.so

    - name: Run repository validation demo
      run: |
        . .venv/bin/activate
        export VERIFIED_KERNEL_PATH="${PWD}/UELAT/kernel_verified.so"
        python tools/run_demo.py || true
      env:
        VERIFIED_KERNEL_PATH: ${{ github.workspace }}/UELAT/kernel_verified.so

    - name: Upload scenario artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: scenario-artifacts
        path: |
          scenarios/*/attack_succeeded.json
          scenarios/*/attack_out/
          assessor.log
