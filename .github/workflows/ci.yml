name: CI / Validation & Release

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write

env:
  # Test tier configuration
  # Tier 1: Unit (no native code)
  # Tier 2: Integration (kernel allowed)
  # Tier 3: Heavy (GPU, full models)
  ESM_TEST_TIER: "integration"

jobs:
  # Tier 1: Fast unit tests (no native code, no model loading)
  unit_tests:
    name: Unit Tests (Tier 1)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      ESM_ALLOW_KERNEL_LOAD: "0"
      ESM_ALLOW_MODEL_LOAD: "0"
      ESM_STRICT: "0"
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-unit-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-unit-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install pytest pytest-timeout numpy scipy pyyaml
          # Install transformers for shim tests (but no model loading)
          python -m pip install transformers torch --index-url https://download.pytorch.org/whl/cpu
          python -m pip install -e . || true

      - name: Run unit tests
        run: |
          pytest tests/ -v -m "unit" \
            --ignore=tests/test_hybrid_certification.py \
            --ignore=tests/test_spectral_prover.py \
            -x --tb=short --durations=20 --timeout=600

      - name: Verify test guards work
        run: |
          python -c "
          from tests.test_guards import is_kernel_allowed, is_model_allowed, TestTierManager
          assert not is_kernel_allowed(), 'Kernel should be disabled'
          assert not is_model_allowed(), 'Model should be disabled'
          assert TestTierManager.current_tier() == TestTierManager.TIER_UNIT
          print('Test guards working correctly')
          "

  build_verified_kernel:
    name: Build Verified Kernel (Docker Coq 8.18.0)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Ensure docker available
        run: docker --version

      - name: Verify Coq image available
        run: docker pull coqorg/coq:8.18.0

      - name: Prepare workspace files & permissions
        run: |
          mkdir -p .kernel_out
          chmod -R a+rwX .kernel_out || true

      - name: Build kernel inside Coq 8.18.0 image
        run: |
          docker run --rm --user root \
            -v "${{ github.workspace }}":/work \
            -v "${{ github.workspace }}/.kernel_out":/kernel_out \
            -w /work \
            -e OPAMROOT=/home/coq/.opam \
            -e OPAMCONFIRMLEVEL=unsafe-yes \
            coqorg/coq:8.18.0 \
            bash -c "eval \$(opam env 2>/dev/null) && KERNEL_OUTPUT=/kernel_out/kernel_verified.so bash ./build_kernel.sh"

      - name: Verify created artifact and produce checksum
        run: |
          if [ ! -f ".kernel_out/kernel_verified.so" ]; then
            echo "ERROR: .kernel_out/kernel_verified.so not produced"
            ls -la .kernel_out || true
            exit 1
          fi
          # Use relative path in checksum so it works after artifact download to UELAT/
          (cd .kernel_out && sha256sum kernel_verified.so > kernel_verified.so.sha256)
          echo "Produced:"
          cat .kernel_out/kernel_verified.so.sha256

      - name: (Optional) Sign artifact (if signing is desired)
        run: |
          if command -v python3 >/dev/null 2>&1 && [ -f tools/sign_index.py ]; then
            chmod +x .github/scripts/sign_artifact.sh || true
            .github/scripts/sign_artifact.sh
          fi
          ls -la .kernel_out || true
        shell: bash

      - name: Upload verified kernel artifact
        uses: actions/upload-artifact@v4
        with:
          name: verified-kernel
          path: |
            .kernel_out/kernel_verified.so
            .kernel_out/kernel_verified.so.sha256
            .kernel_out/kernel_verified.so.sha256.sig
          if-no-files-found: error


  validate-and-integrate:
    name: Integration Tests (Tier 2)
    runs-on: ubuntu-latest
    needs: [unit_tests, build_verified_kernel]
    timeout-minutes: 30
    env:
      IMAGE_NAME: esm-agentbench:ci
      CONTAINER_NAME: esm-assessor
      # Default to Python fallback; kernel build step may enable verified kernel if successful
      ESM_SKIP_VERIFIED_KERNEL: "1"
      # Tier 2: Integration - kernel and model loading allowed
      ESM_ALLOW_KERNEL_LOAD: "1"
      ESM_ALLOW_MODEL_LOAD: "1"
      ESM_STRICT: "1"
      # Enable diagnostics for crash reports
      ESM_ENABLE_DIAGNOSTICS: "1"

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Python venv
        run: |
          python -m venv .venv
          . .venv/bin/activate
          python -m pip install --upgrade pip setuptools wheel

      - name: Install HF stack + project
        run: |
          . .venv/bin/activate
          python -m pip uninstall -y huggingface-hub sentence-transformers transformers || true
          # canonical HF stack - install transformers>=4.36.0 for Phi-3 model compatibility (cache_utils module)
          python -m pip install --no-cache-dir "huggingface-hub>=0.19.3" "sentence-transformers==2.3.1" "transformers>=4.36.0"
          # Install matplotlib with dependencies (so pyparsing, packaging, kiwisolver, fonttools, ...)
          # We install matplotlib explicitly so that installing requirements with --no-deps
          # won't leave matplotlib half-installed.
          python -m pip install --no-cache-dir matplotlib==3.8.1
          # Install the rest of the pinned requirements without re-resolving the HF stack
          python -m pip install --no-cache-dir -r requirements.txt --no-deps
          # Use --no-deps to prevent pip from re-resolving and potentially downgrading transformers
          python -m pip install --no-deps -e .
          # Verify transformers version is 4.36.0+ (required for Phi-3's cache_utils imports)
          python -c "import transformers; v=transformers.__version__; parts=v.split('.')[:2]; assert int(parts[0])>=4 and int(parts[1])>=36, f'transformers {v} < 4.36.0'; print(f'transformers {v} OK')"

      - name: Download kernel artifact
        uses: actions/download-artifact@v4
        with:
          name: verified-kernel
          path: UELAT/

      - name: Verify importability
        run: |
          . .venv/bin/activate
          python - <<'PY'
          import sys, importlib
          importlib.invalidate_caches()
          try:
              import tools
              print("tools importable:", tools.__file__)
          except Exception as e:
              print("ERROR: tools not importable:", e, file=sys.stderr)
              raise
          PY

      - name: Prefetch models for judge-mode
        run: |
          . .venv/bin/activate
          chmod +x ./scripts/preload_models.sh
          ./scripts/preload_models.sh

      - name: Set VERIFIED_KERNEL_PATH and verify checksum
        run: |
          if [ -f "${{ github.workspace }}/UELAT/kernel_verified.so" ]; then
            echo "Using prebuilt kernel: UELAT/kernel_verified.so"
            echo "VERIFIED_KERNEL_PATH=${{ github.workspace }}/UELAT/kernel_verified.so" >> $GITHUB_ENV
            # Run from UELAT/ dir since checksum file contains relative path
            (cd UELAT && sha256sum -c kernel_verified.so.sha256) || (echo "checksum mismatch" && exit 1)
            if [ -f "UELAT/kernel_verified.so.sha256.sig" ] && [ -f "UELAT/public.key" ]; then
              python3 -m pip install --no-cache-dir PyNaCl || true
              python3 tools/verify_signature.py --index UELAT/kernel_verified.so.sha256 --sig UELAT/kernel_verified.so.sha256.sig --pubkey UELAT/public.key
            fi
            echo "ESM_SKIP_VERIFIED_KERNEL=0" >> "$GITHUB_ENV"
          else
            echo "No prebuilt kernel found; falling back to Python path."
            echo "ESM_SKIP_VERIFIED_KERNEL=1" >> "$GITHUB_ENV"
          fi

      - name: Collect verified kernel diagnostics
        run: |
          KERNEL_PATH="${{ github.workspace }}/UELAT/kernel_verified.so"
          mkdir -p kernel_diagnostics
          if [ -f "$KERNEL_PATH" ]; then
            echo "Collecting diagnostics for $KERNEL_PATH"
            file "$KERNEL_PATH" > kernel_diagnostics/kernel_file.txt || true
            if command -v ldd >/dev/null 2>&1; then
              ldd "$KERNEL_PATH" > kernel_diagnostics/kernel_ldd.txt || true
            else
              echo "ldd not available" > kernel_diagnostics/kernel_ldd.txt
            fi
            if command -v readelf >/dev/null 2>&1; then
              readelf -d "$KERNEL_PATH" > kernel_diagnostics/kernel_readelf.txt || true
            else
              echo "readelf not available" > kernel_diagnostics/kernel_readelf.txt
            fi
          else
            echo "Kernel not found; skipping diagnostics." > kernel_diagnostics/kernel_missing.txt
          fi

      - name: Verify Python environment
        run: |
          . .venv/bin/activate
          echo "=== Current working directory ==="
          pwd
          echo ""
          echo "=== Verify tools package and Python sys.path ==="
          python - <<'PY'
          import sys
          import tools
          from tools.real_agents_hf.trace import RUN_GENERATOR

          print('Python sys.path:')
          for p in sys.path:
              print(f'  {p}')
          print()
          print(f'tools package: {tools.__file__}')
          print('tools.real_agents_hf imports OK')
          PY

      - name: Run Unit Tests (inside Coq/OCaml runtime)
        run: |
          # Verify kernel exists
          KERN_DIR="${{ github.workspace }}/UELAT"
          if [ ! -f "$KERN_DIR/kernel_verified.so" ]; then
            echo "ERROR: kernel not found at $KERN_DIR/kernel_verified.so"
            ls -la "$KERN_DIR" || true
            exit 1
          fi

          # Run tests inside Coq container where OCaml runtime is available
          # Use --user root and eval opam env like the build step does
          docker run --rm --user root \
            -v "${{ github.workspace }}":/work \
            -w /work \
            -e OPAMROOT=/home/coq/.opam \
            -e OPAMCONFIRMLEVEL=unsafe-yes \
            coqorg/coq:8.18.0 \
            bash -c "
              set -euo pipefail
              eval \$(opam env 2>/dev/null)
              export VERIFIED_KERNEL_PATH=/work/UELAT/kernel_verified.so
              # Ensure OCaml runtime libraries are in LD_LIBRARY_PATH (backup for dynamic linking)
              OCAML_STDLIB=\$(ocamlfind printconf stdlib 2>/dev/null || ocamlopt -where 2>/dev/null || echo '')
              if [ -n \"\$OCAML_STDLIB\" ]; then
                export LD_LIBRARY_PATH=\"\$OCAML_STDLIB:\${LD_LIBRARY_PATH:-}\"
                echo \"Added OCaml stdlib to LD_LIBRARY_PATH: \$OCAML_STDLIB\"
              fi
              # Install python3-venv (required for venv creation)
              apt-get update && apt-get install -y python3-venv python3-pip
              # Prepare Python venv inside container
              python3 -m venv .venv-docker
              . .venv-docker/bin/activate
              python -m pip install --upgrade pip setuptools wheel
              # Install CPU-only torch first to avoid huge CUDA downloads
              python -m pip install --no-cache-dir torch --index-url https://download.pytorch.org/whl/cpu
              # Install Python deps (skip torch since we installed CPU version)
              python -m pip install --no-cache-dir -r requirements.txt --no-deps
              python -m pip install -e . || true
              # Run pytest with integration tier settings
              export ESM_ALLOW_KERNEL_LOAD=1
              export ESM_ALLOW_MODEL_LOAD=1
              export ESM_STRICT=1
              pytest -q -m 'not heavy'
              # Run math validation (this works reliably)
              python tools/test_drift_metric_standalone.py
              # NOTE: validate_real_traces.py is skipped in CI because it requires
              # sentence-transformers which causes SIGSEGV in the Coq Docker environment.
              # The core math is validated by test_drift_metric_standalone.py above.
              # For full embedding validation, run locally or in a dedicated ML container.
            "
        timeout-minutes: 45

      - name: Verify Math (Drift Metric Standalone)
        env:
          # Must skip kernel outside Docker - OCaml runtime not available
          ESM_SKIP_VERIFIED_KERNEL: "1"
        run: |
          . .venv/bin/activate
          python tools/test_drift_metric_standalone.py

      - name: Build Docker image
        run: docker build -t $IMAGE_NAME .

      - name: Start Green Agent Container
        run: |
          # Pass ESM_FORCE_TFIDF=1 to prevent heavy model downloads in CI
          # Note: removed --rm flag so we can capture logs if container crashes
          docker run -d \
            --name $CONTAINER_NAME \
            -p 8080:8080 \
            -e ESM_FORCE_TFIDF=1 \
            $IMAGE_NAME
          sleep 5

      - name: Wait for Healthcheck
        run: |
          set -e
          echo "Waiting for agent-card at http://localhost:8080/.well-known/agent-card.json"
          for i in $(seq 1 30); do
            # Check if container is still running
            if ! docker ps -q -f name=$CONTAINER_NAME | grep -q .; then
              echo "âŒ Container exited unexpectedly."
              echo "--- Container logs ---"
              docker logs $CONTAINER_NAME 2>&1 || echo "No logs available"
              exit 1
            fi
            if curl -sSf http://localhost:8080/.well-known/agent-card.json >/dev/null 2>&1; then
              echo "âœ… Assessor is healthy."
              exit 0
            fi
            sleep 2
          done
          echo "âŒ Assessor failed to boot (timeout after 60s)."
          echo "--- Container logs ---"
          docker logs $CONTAINER_NAME 2>&1 || echo "No logs available"
          exit 1

      - name: Run SWE-Bench Safety Demo (Integration)
        env:
          ASSESS_ENDPOINT: http://localhost:8080/run_episode
          DEMO_MAX_EPISODES: 3
        run: |
          . .venv/bin/activate
          echo "ðŸš€ Running integration test against Docker..."
          # This matches the renamed file
          python tools/run_demo.py

      - name: Validate Certificates & Report
        run: |
          . .venv/bin/activate
          if ! ls demo_traces/*_certificate.json 1> /dev/null 2>&1; then
            echo "âŒ No certificates found!"
            exit 1
          fi
          python tools/generate_validation_report.py

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: validation-artifacts
          path: |
            validation_history/*.md
            validation_history/*.json
            demo_swe/report.json
            demo_traces/*.json
            kernel_diagnostics/*

      - name: Cleanup Container
        if: always()
        run: docker rm -f $CONTAINER_NAME 2>/dev/null || true

      - name: Update Validation History
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add validation_history/ BENCHMARKS.md
          if git diff --cached --quiet; then
            echo "No changes."
          else
            git commit -m "ci: update validation metrics [skip ci]"
            git push
