name: CI / Validation & Release

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build_verified_kernel:
    name: Build Verified Kernel (Docker Coq 8.18.0)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Ensure docker available
        run: docker --version

      - name: Verify Coq image available
        run: docker pull coqorg/coq:8.18.0

      - name: Prepare workspace files & permissions
        run: |
          mkdir -p .kernel_out
          chmod -R a+rwX .kernel_out || true

      - name: Build kernel inside Coq 8.18.0 image
        run: |
          docker run --rm --user root \
            -v "${{ github.workspace }}":/work \
            -v "${{ github.workspace }}/.kernel_out":/kernel_out \
            -w /work \
            -e OPAMROOT=/home/coq/.opam \
            -e OPAMCONFIRMLEVEL=unsafe-yes \
            coqorg/coq:8.18.0 \
            bash -c "eval \$(opam env 2>/dev/null) && KERNEL_OUTPUT=/kernel_out/kernel_verified.so bash ./build_kernel.sh"

      - name: Verify created artifact and produce checksum
        run: |
          if [ ! -f ".kernel_out/kernel_verified.so" ]; then
            echo "ERROR: .kernel_out/kernel_verified.so not produced"
            ls -la .kernel_out || true
            exit 1
          fi
          # Use relative path in checksum so it works after artifact download to UELAT/
          (cd .kernel_out && sha256sum kernel_verified.so > kernel_verified.so.sha256)
          echo "Produced:"
          cat .kernel_out/kernel_verified.so.sha256

      - name: (Optional) Sign artifact (if signing is desired)
        run: |
          if command -v python3 >/dev/null 2>&1 && [ -f tools/sign_index.py ]; then
            chmod +x .github/scripts/sign_artifact.sh || true
            .github/scripts/sign_artifact.sh
          fi
          ls -la .kernel_out || true
        shell: bash

      - name: Upload verified kernel artifact
        uses: actions/upload-artifact@v4
        with:
          name: verified-kernel
          path: |
            .kernel_out/kernel_verified.so
            .kernel_out/kernel_verified.so.sha256
            .kernel_out/kernel_verified.so.sha256.sig
          if-no-files-found: error

  validate-with-kernel:
    name: Validate Real Traces WITH Verified Kernel
    runs-on: ubuntu-latest
    needs: build_verified_kernel
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download kernel artifact
        uses: actions/download-artifact@v4
        with:
          name: verified-kernel
          path: UELAT/

      - name: Run validation with kernel using LD_PRELOAD
        run: |
          # Run inside Coq container where OCaml runtime is available
          # Use LD_PRELOAD to force compatible BLAS/LAPACK for both kernel and PyTorch
          docker run --rm --user root \
            -v "${{ github.workspace }}":/work \
            -w /work \
            -e OPAMROOT=/home/coq/.opam \
            -e OPAMCONFIRMLEVEL=unsafe-yes \
            coqorg/coq:8.18.0 \
            bash -c '
              set -euo pipefail
              eval $(opam env 2>/dev/null)

              # Set kernel path
              export VERIFIED_KERNEL_PATH=/work/UELAT/kernel_verified.so

              # Find OCaml stdlib and BLAS libraries
              OCAML_STDLIB=$(ocamlfind printconf stdlib 2>/dev/null || ocamlopt -where 2>/dev/null || echo "")

              # Install system BLAS/LAPACK (shared between OCaml and Python)
              # Use ONLY OpenBLAS (includes LAPACK internally, no mixing)
              apt-get update -qq
              apt-get install -y -qq libopenblas0-pthread libopenblas-dev python3-pip python3-venv

              # Find OpenBLAS library (it includes BLAS + LAPACK)
              OPENBLAS_LIB=$(find /usr/lib -name "libopenblas*.so*" | grep -v ".a$" | head -1)

              echo "Using OpenBLAS library: $OPENBLAS_LIB"

              # Preload ONLY OpenBLAS (don't mix with separate libblas/liblapack)
              if [ -n "$OPENBLAS_LIB" ]; then
                export LD_PRELOAD="$OPENBLAS_LIB"
                echo "LD_PRELOAD set to: $LD_PRELOAD"
              else
                echo "WARNING: OpenBLAS not found, proceeding without LD_PRELOAD"
              fi

              # Add OCaml libs to library path
              if [ -n "$OCAML_STDLIB" ]; then
                export LD_LIBRARY_PATH="$OCAML_STDLIB:${LD_LIBRARY_PATH:-}"
              fi

              # Setup Python venv
              python3 -m venv .venv-kernel
              . .venv-kernel/bin/activate
              pip install --upgrade pip setuptools wheel -q

              # Install numpy first, force it to use OpenBLAS
              pip install --no-cache-dir numpy -q

              # Install CPU-only PyTorch (will use system OpenBLAS via numpy)
              pip install --no-cache-dir torch --index-url https://download.pytorch.org/whl/cpu -q

              # Install HF stack
              pip install --no-cache-dir "huggingface-hub==0.16.4" "sentence-transformers==2.3.1" "transformers==4.35.2" -q
              pip install --no-cache-dir -r requirements.txt --no-deps -q
              pip install -e . -q

              # Download sentence-transformers model
              python -c "from sentence_transformers import SentenceTransformer; SentenceTransformer(\"sentence-transformers/all-MiniLM-L6-v2\")"

              echo "================================"
              echo "Running validate_real_traces.py with verified kernel"
              echo "LD_PRELOAD=$LD_PRELOAD"
              echo "VERIFIED_KERNEL_PATH=$VERIFIED_KERNEL_PATH"
              echo "================================"

              # Check what libraries will be loaded
              echo "Checking library dependencies..."
              ldd "$VERIFIED_KERNEL_PATH" | head -20 || true
              echo ""

              # Run validation WITH kernel (ESM_SKIP_VERIFIED_KERNEL not set)
              python tools/validate_real_traces.py || {
                echo "================================"
                echo "SIGSEGV STILL OCCURRED - Library conflict persists"
                echo "================================"
                echo "This is a known limitation: OCaml/Coq kernel and PyTorch/sentence-transformers"
                echo "have deep library conflicts that cannot be resolved with LD_PRELOAD alone."
                echo ""
                echo "The kernel IS verified separately in build_verified_kernel job."
                echo "For trace validation, we use Python fallback (same formulas, not verified)."
                echo "================================"
                exit 1
              }
            '
        timeout-minutes: 15

  validate-and-integrate:
    runs-on: ubuntu-latest
    needs: build_verified_kernel
    timeout-minutes: 20
    env:
      IMAGE_NAME: esm-agentbench:ci
      CONTAINER_NAME: esm-assessor
      # Default to Python fallback; kernel build step may enable verified kernel if successful
      ESM_SKIP_VERIFIED_KERNEL: "1"

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Python venv
        run: |
          python -m venv .venv
          . .venv/bin/activate
          python -m pip install --upgrade pip setuptools wheel

      - name: Install HF stack + project
        run: |
          . .venv/bin/activate
          python -m pip uninstall -y huggingface-hub sentence-transformers transformers || true
          # canonical HF stack
          python -m pip install --no-cache-dir "huggingface-hub==0.16.4" "sentence-transformers==2.3.1" "transformers==4.35.2"
          python -m pip install --no-cache-dir -r requirements.txt --no-deps
          python -m pip install -e .

      - name: Download kernel artifact
        uses: actions/download-artifact@v4
        with:
          name: verified-kernel
          path: UELAT/

      - name: Verify importability
        run: |
          . .venv/bin/activate
          python - <<'PY'
          import sys, importlib
          importlib.invalidate_caches()
          try:
              import tools
              print("tools importable:", tools.__file__)
          except Exception as e:
              print("ERROR: tools not importable:", e, file=sys.stderr)
              raise
          PY

      - name: Prefetch models for judge-mode
        run: |
          . .venv/bin/activate
          chmod +x ./scripts/preload_models.sh
          ./scripts/preload_models.sh

      - name: Set VERIFIED_KERNEL_PATH and verify checksum
        run: |
          if [ -f "${{ github.workspace }}/UELAT/kernel_verified.so" ]; then
            echo "Using prebuilt kernel: UELAT/kernel_verified.so"
            echo "VERIFIED_KERNEL_PATH=${{ github.workspace }}/UELAT/kernel_verified.so" >> $GITHUB_ENV
            # Run from UELAT/ dir since checksum file contains relative path
            (cd UELAT && sha256sum -c kernel_verified.so.sha256) || (echo "checksum mismatch" && exit 1)
            if [ -f "UELAT/kernel_verified.so.sha256.sig" ] && [ -f "UELAT/public.key" ]; then
              python3 -m pip install --no-cache-dir PyNaCl || true
              python3 tools/verify_signature.py --index UELAT/kernel_verified.so.sha256 --sig UELAT/kernel_verified.so.sha256.sig --pubkey UELAT/public.key
            fi
            echo "ESM_SKIP_VERIFIED_KERNEL=0" >> "$GITHUB_ENV"
          else
            echo "No prebuilt kernel found; falling back to Python path."
            echo "ESM_SKIP_VERIFIED_KERNEL=1" >> "$GITHUB_ENV"
          fi

      - name: Verify Python environment
        run: |
          . .venv/bin/activate
          echo "=== Current working directory ==="
          pwd
          echo ""
          echo "=== Verify tools package and Python sys.path ==="
          python - <<'PY'
          import sys
          import tools
          from tools.real_agents_hf.trace import RUN_GENERATOR

          print('Python sys.path:')
          for p in sys.path:
              print(f'  {p}')
          print()
          print(f'tools package: {tools.__file__}')
          print('tools.real_agents_hf imports OK')
          PY

      - name: Run Unit Tests (inside Coq/OCaml runtime)
        run: |
          # Verify kernel exists
          KERN_DIR="${{ github.workspace }}/UELAT"
          if [ ! -f "$KERN_DIR/kernel_verified.so" ]; then
            echo "ERROR: kernel not found at $KERN_DIR/kernel_verified.so"
            ls -la "$KERN_DIR" || true
            exit 1
          fi

          # Run tests inside Coq container where OCaml runtime is available
          # Use --user root and eval opam env like the build step does
          docker run --rm --user root \
            -v "${{ github.workspace }}":/work \
            -w /work \
            -e OPAMROOT=/home/coq/.opam \
            -e OPAMCONFIRMLEVEL=unsafe-yes \
            coqorg/coq:8.18.0 \
            bash -c "
              set -euo pipefail
              eval \$(opam env 2>/dev/null)
              export VERIFIED_KERNEL_PATH=/work/UELAT/kernel_verified.so
              # Ensure OCaml runtime libraries are in LD_LIBRARY_PATH (backup for dynamic linking)
              OCAML_STDLIB=\$(ocamlfind printconf stdlib 2>/dev/null || ocamlopt -where 2>/dev/null || echo '')
              if [ -n \"\$OCAML_STDLIB\" ]; then
                export LD_LIBRARY_PATH=\"\$OCAML_STDLIB:\${LD_LIBRARY_PATH:-}\"
                echo \"Added OCaml stdlib to LD_LIBRARY_PATH: \$OCAML_STDLIB\"
              fi
              # Install python3-venv (required for venv creation)
              apt-get update && apt-get install -y python3-venv python3-pip
              # Prepare Python venv inside container
              python3 -m venv .venv-docker
              . .venv-docker/bin/activate
              python -m pip install --upgrade pip setuptools wheel
              # Install CPU-only torch first to avoid huge CUDA downloads
              python -m pip install --no-cache-dir torch --index-url https://download.pytorch.org/whl/cpu
              # Install Python deps (skip torch since we installed CPU version)
              python -m pip install --no-cache-dir -r requirements.txt --no-deps
              python -m pip install -e . || true
              # Run pytest
              pytest -q
              # Run math validation (this works reliably)
              python tools/test_drift_metric_standalone.py
              # NOTE: validate_real_traces.py is skipped in CI because it requires
              # sentence-transformers which causes SIGSEGV in the Coq Docker environment.
              # The core math is validated by test_drift_metric_standalone.py above.
              # For full embedding validation, run locally or in a dedicated ML container.
            "
        timeout-minutes: 45

      - name: Verify Math (Drift Metric Standalone)
        env:
          # Must skip kernel outside Docker - OCaml runtime not available
          ESM_SKIP_VERIFIED_KERNEL: "1"
        run: |
          . .venv/bin/activate
          python tools/test_drift_metric_standalone.py

      - name: Build Docker image
        run: docker build -t $IMAGE_NAME .

      - name: Start Green Agent Container
        run: |
          # Pass ESM_FORCE_TFIDF=1 to prevent heavy model downloads in CI
          docker run -d --rm \
            --name $CONTAINER_NAME \
            -p 8080:8080 \
            -e ESM_FORCE_TFIDF=1 \
            $IMAGE_NAME
          sleep 5

      - name: Wait for Healthcheck
        run: |
          set -e
          echo "Waiting for agent-card at http://localhost:8080/.well-known/agent-card.json"
          for i in $(seq 1 30); do
            if curl -sSf http://localhost:8080/.well-known/agent-card.json >/dev/null 2>&1; then
              echo "‚úÖ Assessor is healthy."
              exit 0
            fi
            sleep 2
          done
          echo "‚ùå Assessor failed to boot."
          docker logs $CONTAINER_NAME
          exit 1

      - name: Run SWE-Bench Safety Demo (Integration)
        env:
          ASSESS_ENDPOINT: http://localhost:8080/run_episode
          DEMO_MAX_EPISODES: 3
        run: |
          . .venv/bin/activate
          echo "üöÄ Running integration test against Docker..."
          # This matches the renamed file
          python tools/run_demo.py

      - name: Validate Certificates & Report
        run: |
          . .venv/bin/activate
          if ! ls demo_traces/*_certificate.json 1> /dev/null 2>&1; then
            echo "‚ùå No certificates found!"
            exit 1
          fi
          python tools/generate_validation_report.py

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: validation-artifacts
          path: |
            validation_history/*.md
            validation_history/*.json
            demo_swe/report.json
            demo_traces/*.json

      - name: Update Validation History
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add validation_history/ BENCHMARKS.md
          if git diff --cached --quiet; then
            echo "No changes."
          else
            git commit -m "ci: update validation metrics [skip ci]"
            git push
