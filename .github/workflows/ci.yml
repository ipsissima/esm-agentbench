name: CI / Validation & Release

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build_verified_kernel:
    name: Build Verified Kernel (Docker Coq 8.18.1)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Ensure docker available
        run: docker --version

      - name: Verify Coq image available
        run: docker pull coqorg/coq:8.18.1

      - name: Build kernel inside Coq 8.18.1 image
        run: |
          docker run --rm -v "${{ github.workspace }}":/work -w /work \
            coqorg/coq:8.18.1 \
            bash -lc "chmod +x ./build_kernel.sh && ./build_kernel.sh"

      - name: Verify created artifact and produce checksum
        run: |
          if [ ! -f "UELAT/kernel_verified.so" ]; then
            echo "ERROR: UELAT/kernel_verified.so not produced"
            ls -la UELAT || true
            exit 1
          fi
          sha256sum UELAT/kernel_verified.so > UELAT/kernel_verified.so.sha256
          echo "Produced:"
          cat UELAT/kernel_verified.so.sha256

      - name: Upload verified kernel artifact
        uses: actions/upload-artifact@v4
        with:
          name: verified-kernel
          path: |
            UELAT/kernel_verified.so
            UELAT/kernel_verified.so.sha256
          if-no-files-found: error

  validate-and-integrate:
    runs-on: ubuntu-latest
    needs: build_verified_kernel
    timeout-minutes: 20
    env:
      IMAGE_NAME: esm-agentbench:ci
      CONTAINER_NAME: esm-assessor
      # Default to Python fallback; kernel build step may enable verified kernel if successful
      ESM_SKIP_VERIFIED_KERNEL: "1"

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download kernel artifact
        uses: actions/download-artifact@v4
        with:
          name: verified-kernel
          path: UELAT

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Python venv
        run: |
          python -m venv .venv
          . .venv/bin/activate
          python -m pip install --upgrade pip setuptools wheel

      - name: Install HF stack + project
        run: |
          . .venv/bin/activate
          python -m pip uninstall -y huggingface-hub sentence-transformers transformers || true
          # canonical HF stack
          python -m pip install --no-cache-dir "huggingface-hub==0.16.4" "sentence-transformers==2.3.1" "transformers==4.35.2"
          python -m pip install --no-cache-dir -r requirements.txt --no-deps
          python -m pip install -e .

      - name: Verify importability
        run: |
          . .venv/bin/activate
          python - <<'PY'
          import sys, importlib
          importlib.invalidate_caches()
          try:
              import tools
              print("tools importable:", tools.__file__)
          except Exception as e:
              print("ERROR: tools not importable:", e, file=sys.stderr)
              raise
          PY

      - name: Pre-download sentence-transformers model
        run: |
          . .venv/bin/activate
          python -c "from sentence_transformers import SentenceTransformer; SentenceTransformer('sentence-transformers/all-MiniLM-L6-v2')"

      - name: Prefetch models for judge-mode
        run: |
          . .venv/bin/activate
          chmod +x ./scripts/preload_models.sh
          ./scripts/preload_models.sh

      - name: Set VERIFIED_KERNEL_PATH
        run: echo "VERIFIED_KERNEL_PATH=${{ github.workspace }}/UELAT/kernel_verified.so" >> "$GITHUB_ENV"

      - name: Verify kernel checksum
        run: |
          if [ -f "$VERIFIED_KERNEL_PATH" ]; then
            echo "Using prebuilt kernel: $VERIFIED_KERNEL_PATH"
            sha256sum -c UELAT/kernel_verified.so.sha256 || (echo "checksum mismatch" && exit 1)
            echo "ESM_SKIP_VERIFIED_KERNEL=0" >> "$GITHUB_ENV"
          else
            echo "No prebuilt kernel found; falling back to Python path."
          fi

      - name: Verify Python environment
        run: |
          . .venv/bin/activate
          echo "=== Current working directory ==="
          pwd
          echo ""
          echo "=== Verify tools package and Python sys.path ==="
          python - <<'PY'
          import sys
          import tools
          from tools.real_agents_hf.trace import RUN_GENERATOR

          print('Python sys.path:')
          for p in sys.path:
              print(f'  {p}')
          print()
          print(f'tools package: {tools.__file__}')
          print('tools.real_agents_hf imports OK')
          PY

      - name: Run Unit Tests
        run: |
          . .venv/bin/activate
          pytest -q

      - name: Verify Math (Drift Metric Standalone)
        run: |
          . .venv/bin/activate
          python tools/test_drift_metric_standalone.py

      - name: Verify Embeddings (Real Traces)
        run: |
          . .venv/bin/activate
          python tools/validate_real_traces.py

      - name: Build Docker image
        run: docker build -t $IMAGE_NAME .

      - name: Start Green Agent Container
        run: |
          # Pass ESM_FORCE_TFIDF=1 to prevent heavy model downloads in CI
          docker run -d --rm \
            --name $CONTAINER_NAME \
            -p 8080:8080 \
            -e ESM_FORCE_TFIDF=1 \
            $IMAGE_NAME
          sleep 5

      - name: Wait for Healthcheck
        run: |
          set -e
          echo "Waiting for agent-card at http://localhost:8080/.well-known/agent-card.json"
          for i in $(seq 1 30); do
            if curl -sSf http://localhost:8080/.well-known/agent-card.json >/dev/null 2>&1; then
              echo "‚úÖ Assessor is healthy."
              exit 0
            fi
            sleep 2
          done
          echo "‚ùå Assessor failed to boot."
          docker logs $CONTAINER_NAME
          exit 1

      - name: Run SWE-Bench Safety Demo (Integration)
        env:
          ASSESS_ENDPOINT: http://localhost:8080/run_episode
          DEMO_MAX_EPISODES: 3
        run: |
          . .venv/bin/activate
          echo "üöÄ Running integration test against Docker..."
          # This matches the renamed file
          python tools/run_demo.py

      - name: Validate Certificates & Report
        run: |
          . .venv/bin/activate
          if ! ls demo_traces/*_certificate.json 1> /dev/null 2>&1; then
            echo "‚ùå No certificates found!"
            exit 1
          fi
          python tools/generate_validation_report.py

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: validation-artifacts
          path: |
            validation_history/*.md
            validation_history/*.json
            demo_swe/report.json
            demo_traces/*.json

      - name: Update Validation History
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add validation_history/ BENCHMARKS.md
          if git diff --cached --quiet; then
            echo "No changes."
          else
            git commit -m "ci: update validation metrics [skip ci]"
            git push
