name: CI

on:
  push:
  pull_request:

permissions:
  contents: write

jobs:
  test-and-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git metadata

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install --upgrade "sentence-transformers>=2.3.0"
          pip install scikit-learn

      - name: Import tutorial assets
        run: python tools/import_tutorial.py || true

      - name: Run pytest
        run: pytest -q

      - name: Run drift metric validation (synthetic embeddings)
        run: python tools/test_drift_metric_standalone.py

      - name: Run real trace validation (sentence-transformers)
        run: python tools/validate_real_traces.py

      - name: Build Docker image
        run: docker build -t esm-agentbench:ci .

      - name: Run demo scenario
        run: |
          export ESM_FORCE_TFIDF=1
          python -m esmassessor.green_server --host 127.0.0.1 --port 8080 --serve-only --show-logs &
          python third_party/tutorial/scenarios/debate/debater.py --host 127.0.0.1 --port 9019 --show-logs &
          sleep 5
          ./agentbeats-run scenarios/esm/scenario.toml --show-logs
          ls demo_traces/*certificate.json

      - name: Validate certificate artifact
        run: |
          python -c "
          import json
          from pathlib import Path
          paths = sorted(Path('demo_traces').glob('*_certificate.json'))
          if not paths:
              raise SystemExit('no certificates produced')
          for p in paths:
              data = json.loads(p.read_text())
              metrics = data.get('spectral_metrics', {})
              if 'residual' not in metrics:
                  raise SystemExit(f'missing residual in {p}')
          print('validated', len(paths), 'certificates')
          "

      - name: Generate validation report
        run: python tools/generate_validation_report.py

      - name: Upload validation reports
        uses: actions/upload-artifact@v4
        with:
          name: validation-reports
          path: |
            validation_history/*.json
            validation_history/*.md

      - name: Commit validation history (main branch only)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add validation_history/ BENCHMARKS.md
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ci: update validation history [skip ci]"
            git push
          fi
