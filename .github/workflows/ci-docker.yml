name: CI - Docker build & integration

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  build-and-integration:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      IMAGE_NAME: esm-agentbench:ci
      CONTAINER_NAME: esm-assessor
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install host Python deps (for running demo driver & pytest)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build Docker image
        run: |
          docker build -t $IMAGE_NAME .

      - name: Start Docker container
        run: |
          # Run in detached mode, publish port 8080
          docker run -d --rm --name $CONTAINER_NAME -p 8080:8080 $IMAGE_NAME
          # Give container a little time to boot
          sleep 1

      - name: Wait for assessor health (agent-card)
        run: |
          set -e
          echo "Waiting for assessor agent-card at http://localhost:8080/.well-known/agent-card.json"
          for i in $(seq 1 60); do
            if curl -sSf http://localhost:8080/.well-known/agent-card.json >/dev/null 2>&1; then
              echo "Assessor healthy after $i attempts"
              curl -s http://localhost:8080/.well-known/agent-card.json | jq -c .
              break
            fi
            echo "Waiting for assessor to be healthy ($i/60)..."
            sleep 1
          done
          # Final check: fail if not healthy
          curl -sSf http://localhost:8080/.well-known/agent-card.json >/dev/null

      - name: Run demo driver against container (POST episodes)
        env:
          ASSESS_ENDPOINT: http://localhost:8080/run_episode
          DEMO_MAX_EPISODES: 3
          DEMO_HTTP_TIMEOUT: 30
        run: |
          # Run the offline driver which POSTs episodes to the running container
          python tools/run_demo_swe.py

      - name: Validate demo output
        run: |
          if [ ! -f demo_swe/report.json ]; then
            echo "demo_swe/report.json missing"
            exit 1
          fi
          python -c "
          import json, sys
          r = json.load(open('demo_swe/report.json'))
          if 'episodes' not in r or not r['episodes']:
              print('report missing episodes or episodes empty')
              sys.exit(1)
          print('Demo report OK: episodes=', len(r['episodes']))
          "

      - name: Run pytest (unit + integration)
        run: |
          pytest -q

      - name: Stop container
        if: always()
        run: |
          docker stop $CONTAINER_NAME || true

      - name: Upload demo report as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: demo-report
          path: demo_swe/report.json

      - name: Print container logs on failure
        if: failure()
        run: |
          echo "===== Docker logs for debugging ====="
          docker logs $CONTAINER_NAME || true
